{"title":"Power Pages登录报错\"multiple entities are present\"","date":"2024-01-16T00:00:00.000Z","date_formatted":{"ll":"Jan 16, 2024","L":"01/16/2024","MM-DD":"01-16"},"thumbnail":"/images/thumbnails/multiple-entities-are-present.jpg","link":"2024/01/16/multiple-entities-are-present","comments":true,"tags":["Power Apps Portal","Power Pages"],"updated":"2024-11-02T17:06:14.824Z","content":"<p>最近，我们遇到了这样一个问题，某些Power Pages的用户在通过 Azure AD B2C 登录时无法登录site。如果该Power Pages site 还没有启用<a href=\"https://learn.microsoft.com/en-us/power-pages/admin/view-portal-error-log#custom-error\" target=\"_blank\">custom error</a>，或者配置了<a href=\"https://learn.microsoft.com/en-us/power-pages/admin/view-portal-error-log#enable-diagnostic-logging\" target=\"_blank\">diagnostics logging</a>，我们可以看到来自Power Pages服务器端的错误消息是&quot;Multiple entities are present&quot;。</p>\n<p><img src=\"/images/multiple-entities-are-present/server-error.png\" alt=\"\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"原因\">原因<a title=\"#原因\" href=\"#原因\"></a></h2>\n<p>通过一些调查，我们发现该问题是由于重复的External Identity记录造成的。</p>\n<p>众所周知，首次通过External Identity Provider（如 Azure AD、Azure AD B2C、Google 等）登录 Power Pages site时，它将生成External Identity记录并与contact记录相关联。External Identity记录包含Username、Identity Provider和与之关联的contact。Username是External Identity Provider系统中的Object ID，Identity Provider是External Identity颁发者的 URL。</p>\n<p>因此，通过External Identity Provider登录 Power Pages 时，一旦在External Identity Provider端完成登录过程，它将跳转到 Power Pages，以找出哪个contact（Power Pages user）与这个External Identity的用户相映射，然后使用contact登录站点。</p>\n<p>但是，如果Dataverse中有多个相同Username和Identity Provider的External Identity记录，则会导致&quot;Multiple entities are present&quot;错误，因为 Power Pages 不知道哪个External Identity记录是正确的，哪个关联的contact是正确的Power Pages用户。</p>\n<h2 id=\"查找重复的external-identity记录\">查找重复的External Identity记录<a title=\"#查找重复的external-identity记录\" href=\"#查找重复的external-identity记录\"></a></h2>\n<p>若要找出重复的的External Identity记录，首先需要知道Username（Object ID）。您可以从External Identity Provider系统找到它，也可以先从 Dataverse 中找到contact记录，然后切换到&quot;Web Authentication&quot; tab中从&quot;External Identities&quot; subgrid中获取Username。</p>\n<p><code>https://xxx.crm.dynamics.com/api/data/v9.2/adx_externalidentities?$select=adx_username,adx_identityprovidername,_adx_contactid_value&amp;$filter=adx_username eq 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'</code></p>\n<p><img src=\"/images/multiple-entities-are-present/external-identities.png\" alt=\"\" loading=\"lazy\" class=\"φbp\"></p>\n<p>有了 Username 的值，可以通过Advanced Find 或 WebApi 查找重复的External Identity记录。找到重复的External Identity记录后，您需要不需要的记录或删除关联的不需要的contact记录，重复的External Identity也将被删除，然后再次尝试登录网站。<br>\n<img src=\"/images/multiple-entities-are-present/advanced-find.png\" alt=\"\" loading=\"lazy\"></p>\n<p>谢谢！</p>\n","next":{"title":"查看Power Pages网站错误日志","link":"2024/01/13/view-portal-error-logs"},"plink":"https://blog.citysouth.cc/2024/01/16/multiple-entities-are-present/","toc":[{"id":"原因","title":"原因","index":"1"},{"id":"查找重复的external-identity记录","title":"查找重复的External Identity记录","index":"2"}],"copyright":{"license":"自由转载-非商用-禁止演绎-保持署名 Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-nd/4.0/\" target=\"_blank\">CC BY-NC-ND 4.0</a>)","published":"January 16, 2024"},"reading_time":"499 words in 4 min"}