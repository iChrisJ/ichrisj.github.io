{"title":"Power Pages与Azure Application Insights的集成","date":"2024-01-09T00:00:00.000Z","date_formatted":{"ll":"Jan 9, 2024","L":"01/09/2024","MM-DD":"01-09"},"thumbnail":"https://ichrisj.gitee.io/reslib/images/thumbnails/integrate-application-insights-with-power-pages.jpg","link":"2024/01/09/integrate-application-insights-with-power-pages","comments":true,"tags":["Application Insights","Power Apps Portal","Power Pages"],"updated":"2024-01-12T18:15:44.806Z","content":"<p>随着Power Pages的发展, 它让企业可以在Power Platform的平台上几乎可以连接到它想接触到的所有用户。Power Pages串联了企业内部与外部的交互. 外部用户不在需要与企业代表而直接向Dataverse提供信息. Power Pages允许用户匿名访问或者以它偏爱的方式登录访问.</p>\n<p>本文我们将介绍Power Pages的admin如何使用某个监控产品, 通过对用户流量和与Power Pages的交互的追踪, 来更好的了解它的用户群体. 企业可以通过这些数据的分析, 来提供最佳的解决方案和体验, 更好的服务用户群体.</p>\n<p>这里我们将使用Azure Application Insights来做解释. 其他的监控产品,例如Google Analytics等, 在Power Pages上的配置类似.</p>\n<h2 id=\"准备application-insights的代码\">准备Application Insights的代码<a title=\"#准备application-insights的代码\" href=\"#准备application-insights的代码\"></a></h2>\n<p>要使用Application Insights, 首先需要有一个Azure的Subscription并且可以创建Application Insights. 创建后, 可以在Overwiew上看到当前Application Insights的Connection String. 之后我们会用到.<br>\n(在某些代码中, 要使用Application Insights, 它需要的是Instrumentation Key)<br>\n<img src=\"https://ichrisj.gitee.io/reslib/images/integrate-application-insights-with-power-pages/connection-string.png\" alt=\"\" loading=\"lazy\"></p>\n<p>然后打开这篇<a href=\"https://learn.microsoft.com/en-us/azure/azure-monitor/app/javascript-sdk?tabs=javascriptwebsdkloaderscript\" target=\"_blank\">文档</a>, 复制下面的样例代码, 并将YOUR_CONNECTION_STRING替换为上面的Connection String.<br>\n<img src=\"https://ichrisj.gitee.io/reslib/images/integrate-application-insights-with-power-pages/jscode.png\" alt=\"\" loading=\"lazy\"></p>\n<h2 id=\"代码嵌入power-pages中\">代码嵌入Power Pages中<a title=\"#代码嵌入power-pages中\" href=\"#代码嵌入power-pages中\"></a></h2>\n<p>在Dataverse中打开Power Page Management app或 Portal Management app(取决Power Pages网站的Data Model是Enhanced还是Standard),在Content Snippet中找到Tracking Code这条记录(如果没有,就创建一条), 然后将上面已经替换Connection String的JavaScript代码放入Value字段中并保存, 并<a href=\"https://learn.microsoft.com/en-us/power-pages/admin/clear-server-side-cache\" target=\"_blank\">清理服务器缓存</a>.<br>\n<img src=\"https://ichrisj.gitee.io/reslib/images/integrate-application-insights-with-power-pages/tracking-code.png\" alt=\"\" loading=\"lazy\"></p>\n<p>如果是在Portal Management app, 还可以通过在Enable Traffic Analysis中添加代码.<br>\n<img src=\"https://ichrisj.gitee.io/reslib/images/integrate-application-insights-with-power-pages/portal-analytics.png\" alt=\"\" loading=\"lazy\"></p>\n<h2 id=\"记录用户信息\">记录用户信息<a title=\"#记录用户信息\" href=\"#记录用户信息\"></a></h2>\n<p>在使用Application Insights来监测Power Pages的使用, 默认它只会记录哪些页面被访问了,哪些地方访问了这样页面等信息. 但是它不会记录是哪些用户访问的, 它也不知道如何记录.<br>\n但是,如果希望了解用户在Power Pages上的行为, 从而给用户提供更好使用体验, 我们就需要记录用户的一些信息. 那如何让Application Insights来记录这些信息呢? 我们需要在Application Insights的代码中添加一些自定制代码.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script type=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><br><span class=\"line\">!(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">cfg</span>)</span>&#123;<span class=\"comment\">/**代码省略**/</span>&#125;)(&#123;</span><br><span class=\"line\"><span class=\"attr\">src</span>: <span class=\"string\">&quot;https://js.monitor.azure.com/scripts/b/ai.3.gbl.min.js&quot;</span>,</span><br><span class=\"line\"><span class=\"comment\">//name: &quot;appInsights&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">// ld: 0,</span></span><br><span class=\"line\"><span class=\"comment\">// useXhr: 1,</span></span><br><span class=\"line\"><span class=\"attr\">crossOrigin</span>: <span class=\"string\">&quot;anonymous&quot;</span>,</span><br><span class=\"line\"><span class=\"comment\">// onInit: null,</span></span><br><span class=\"line\"><span class=\"comment\">// cr: 0,</span></span><br><span class=\"line\"><span class=\"attr\">cfg</span>: &#123; <span class=\"comment\">// Application Insights Configuration</span></span><br><span class=\"line\"> <span class=\"attr\">connectionString</span>: <span class=\"string\">&quot;YOUR_CONNECTION_STRING&quot;</span></span><br><span class=\"line\">&#125;&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//Add User Context</span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">if</span> user %&#125;</span><br><span class=\"line\">    <span class=\"comment\">// track userid and user&#x27;s account id in user_AuthenticatedId and user_AccountId column.</span></span><br><span class=\"line\">    appInsights.setAuthenticatedUserContext(<span class=\"string\">&#x27;&#123;&#123;user.Id&#125;&#125;&#x27;</span>, <span class=\"string\">&#x27;&#123;&#123;user.parentcustomerid.Id&#125;&#125;&#x27;</span>); </span><br><span class=\"line\">    appInsights.trackTrace(&#123; <span class=\"comment\">// track data in trace table</span></span><br><span class=\"line\">        <span class=\"attr\">message</span>: <span class=\"string\">&quot;Authenticated User&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">properties</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;userid&quot;</span>:<span class=\"string\">&quot;&#123;&#123;user.Id&#125;&#125;&quot;</span>, </span><br><span class=\"line\">          <span class=\"string\">&quot;roles&quot;</span>: <span class=\"string\">&quot;&#123;&#123;user.roles | join: &#x27;, &#x27;&#125;&#125;&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"attr\">severityLevel</span>: <span class=\"number\">1</span></span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#123;% <span class=\"keyword\">else</span> %&#125;</span><br><span class=\"line\">    appInsights.clearAuthenticatedUserContext();</span><br><span class=\"line\">    appInsights.trackTrace(&#123; <span class=\"comment\">// track data in trace table</span></span><br><span class=\"line\">      <span class=\"attr\">message</span>: <span class=\"string\">&quot;Anonymous User&quot;</span>,</span><br><span class=\"line\">      <span class=\"attr\">severityLevel</span>: <span class=\"number\">1</span></span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#123;% endif %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">appInsights.trackPageView(); <span class=\"comment\">//Example of tracking Portal Page</span></span><br><span class=\"line\">appInsights.trackEvent(&#123;<span class=\"attr\">name</span>: <span class=\"built_in\">window</span>.Microsoft.Dynamic365.Portal.id&#125;); <span class=\"comment\">//Example of CustomEvent Logging</span></span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>之后我们就可以在Application Insights上Logs中查询得到的追踪的日志信息了.<br>\n例如:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">traces</span><br><span class=\"line\">| where timestamp &gt;= ago(7d)</span><br><span class=\"line\">| project timestamp, message, severityLevel, user_AuthenticatedId, user_AccountId, customDimensions, operation_Name</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://ichrisj.gitee.io/reslib/images/integrate-application-insights-with-power-pages/tracelog.png\" alt=\"\" loading=\"lazy\" class=\"φbp\"></p>\n","prev":{"title":"查看Power Pages网站错误日志","link":"2024/01/13/view-portal-error-logs"},"next":{"title":"Dynamics Marketing: Call a Plugin When a Trigger is Fired","link":"2022/12/16/call-plugins-when-a-trigger-is-fired"},"plink":"https://blog.citysouth.cc/2024/01/09/integrate-application-insights-with-power-pages/","toc":[{"id":"准备application-insights的代码","title":"准备Application Insights的代码","index":"1"},{"id":"代码嵌入power-pages中","title":"代码嵌入Power Pages中","index":"2"},{"id":"记录用户信息","title":"记录用户信息","index":"3"}],"copyright":{"link":"<a href=\"https://blog.citysouth.cc/2024/01/09/integrate-application-insights-with-power-pages/\" title=\"Power Pages与Azure Application Insights的集成\">https://blog.citysouth.cc/2024/01/09/integrate-application-insights-with-power-pages/</a>","license":"自由转载-非商用-禁止演绎-保持署名 Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-nd/4.0/\" target=\"_blank\">CC BY-NC-ND 4.0</a>)","published":"January 9, 2024"},"reading_time":"849 words in 7 min"}