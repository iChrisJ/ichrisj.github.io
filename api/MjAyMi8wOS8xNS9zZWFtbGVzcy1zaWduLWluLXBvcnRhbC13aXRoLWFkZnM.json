{"title":"Seamless sign in Portal with ADFS","date":"2022-09-15T12:52:56.375Z","date_formatted":{"ll":"Sep 15, 2022","L":"09/15/2022","MM-DD":"09-15"},"thumbnail":"https://ichrisj.gitee.io/reslib/images/thumbnails/pedro-lastra-Y9utglm0VpQ-unsplash.jpg","link":"2022/09/15/seamless-sign-in-portal-with-adfs","comments":true,"tags":["Power Apps Portal"],"updated":"2022-09-15T04:52:56.375Z","content":"<p>Starts from CRM Portal v8.0, all the Portal instances are online deployed (except one open source Portal). Portal also provides multiple entries from user to register/sign in it. That means domain users are also to sign in Portal. However, sometimes it’s annoying that every time we need to type our credentials to sign in the Portal even we are in the intranet. Whether we can implement seamless sign in Portal under an intranet?</p>\n<p>Here is one way: ADFS (WS-Federation)</p>\n<p>To implement this, we need to add make some configurations on two parts: ADFS server and the Portal associated CRM org.</p>\n<blockquote>\n<p>Not include Employee Self Service Portal as it is only configured Azure AD to login</p>\n</blockquote>\n<h2 id=\"adfs-server\">ADFS Server<a title=\"#adfs-server\" href=\"#adfs-server\"></a></h2>\n<p>In order to configure ADFS with Portal online, please make sure the ADFS is accessible from internet. That means we are able to access <a href=\"https://adfs.contoso.com/FederationMetadata/2007-06/FederationMetadata.xml\" target=\"_blank\">https://adfs.contoso.com/FederationMetadata/2007-06/FederationMetadata.xml</a> and <a href=\"https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.aspx\" target=\"_blank\">https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.aspx</a>.</p>\n<p>After that, let’s add some settings to AD FS Management tool.<br>\n<em>ref: <a href=\"https://docs.microsoft.com/en-us/powerapps/maker/portals/configure/configure-ws-federation-settings#create-an-ad-fs-relying-party-trust\" target=\"_blank\">https://docs.microsoft.com/en-us/powerapps/maker/portals/configure/configure-ws-federation-settings#create-an-ad-fs-relying-party-trust</a></em></p>\n<h3 id=\"create-an-ad-fs-relying-party-trust\">Create an AD FS relying party trust<a title=\"#create-an-ad-fs-relying-party-trust\" href=\"#create-an-ad-fs-relying-party-trust\"></a></h3>\n<p>Using the AD FS Management tool, go to <strong>Trust Relationships</strong> &gt; <strong>Relying Party Trusts</strong>.</p>\n<ol>\n<li>Select <strong>Add Relying Party Trust</strong>.</li>\n<li>Welcome: Select <strong>Start</strong>.</li>\n<li>Select Data Source: Select <strong>Enter data about the relying party manually</strong>, and then select <strong>Next</strong>.</li>\n<li>Specify Display Name: Enter a <strong>name</strong>, and then select <strong>Next</strong>.<br>\nExample: <a href=\"https://portal.contoso.com/\">https://portal.contoso.com/</a></li>\n<li>Choose Profile: Select <strong>AD FS 2.0 profile</strong>, and then select <strong>Next</strong>.</li>\n<li>Configure Certificate: Select <strong>Next</strong>.</li>\n<li>Configure URL: Select the <strong>Enable support for the WS-Federation Passive protocol</strong> check box.</li>\n</ol>\n<p>Relying party WS-Federation Passive protocol URL: Enter <a href=\"https://portal.contoso.com/signin-federation\">https://portal.contoso.com/signin-federation</a></p>\n<ul>\n<li>\n<p>Note: AD FS requires that the portal run on <strong>HTTPS</strong>.</p>\n<blockquote>\n<p>The resulting endpoint has the following settings:<br>\nEndpoint type: <strong>WS-Federation</strong></p>\n<ul>\n<li>Binding: <strong>POST</strong></li>\n<li>Index: n/a (0)</li>\n<li>URL: <strong><a href=\"https://portal.contoso.com/signin-federation\">https://portal.contoso.com/signin-federation</a></strong></li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<ol start=\"8\">\n<li>Configure Identities: Specify <a href=\"https://portal.contoso.com/\">https://portal.contoso.com/</a>, select <strong>Add</strong>, and then select <strong>Next</strong>.<br>\nIf applicable, more identities can be added for each additional relying party portal. Users will be able to authenticate across any or all of the available identities.</li>\n<li>Choose Issuance Authorization Rules: Select <strong>Permit all users to access this relying party</strong>, and then select <strong>Next</strong>.</li>\n<li>Ready to Add Trust: Select <strong>Next</strong>.</li>\n<li>Select <strong>Close</strong>.</li>\n</ol>\n<p>Add the <strong>Name ID</strong> claim to the relying party trust:</p>\n<p><strong>TransformWindows account name</strong> to <strong>Name ID</strong> claim (Transform an Incoming Claim):</p>\n<ul>\n<li>Incoming claim type: Windows account name</li>\n<li>Outgoing claim type: Name ID</li>\n<li>Outgoing name ID format: Unspecified</li>\n<li>Pass through all claim values</li>\n</ul>\n<h2 id=\"portal-management-in-crm-org\">Portal Management in CRM Org<a title=\"#portal-management-in-crm-org\" href=\"#portal-management-in-crm-org\"></a></h2>\n<p>After the configurations on AD FS, we can add some Portal related settings on CRM.</p>\n<h3 id=\"create-ad-fs-related-site-settings\">Create AD FS related site settings<a title=\"#create-ad-fs-related-site-settings\" href=\"#create-ad-fs-related-site-settings\"></a></h3>\n<p>Go to CRM &gt; Portals &gt; Site Settings, apply portal site settings referencing the above AD FS Relying Party Trust.<br>\n<em>ref: <a href=\"https://docs.microsoft.com/en-us/powerapps/maker/portals/configure/configure-ws-federation-settings#create-ad-fs-site-settings\" target=\"_blank\">https://docs.microsoft.com/en-us/powerapps/maker/portals/configure/configure-ws-federation-settings#create-ad-fs-site-settings</a></em></p>\n<p>A standard AD FS (STS) configuration only uses the following settings (with example values):</p>\n<ul>\n<li>Authentication/WsFederation/ADFS/MetadataAddress - <a href=\"https://adfs.contoso.com/FederationMetadata/2007-06/FederationMetadata.xml\">https://adfs.contoso.com/FederationMetadata/2007-06/FederationMetadata.xml</a></li>\n<li>Authentication/WsFederation/ADFS/AuthenticationType - <a href=\"http://adfs.contoso.com/adfs/services/trust\">http://adfs.contoso.com/adfs/services/trust</a>\n<ul>\n<li>Use the value of the <strong>entityID</strong> attribute in the root element of the Federation Metadata (open the <strong>MetadataAddress URL</strong> in a browser that is the value of the above site setting)</li>\n</ul>\n</li>\n<li>Authentication/WsFederation/ADFS/Wtrealm - <a href=\"https://portal.contoso.com/\">https://portal.contoso.com/</a></li>\n<li>Authentication/WsFederation/ADFS/Wreply - <a href=\"https://portal.contoso.com/signin-federation\">https://portal.contoso.com/signin-federation</a></li>\n</ul>\n<h3 id=\"auto-navigate-to-sign-in-page\">Auto navigate to sign in page<a title=\"#auto-navigate-to-sign-in-page\" href=\"#auto-navigate-to-sign-in-page\"></a></h3>\n<p>In order to automatically navigate to the sign in after typing the Portal URL, we need to create an “Web Page Access Control Rule” record.</p>\n<div class=\"φbq\"><div class=\"φbs\"><table><thead>\n<tr>\n<th style=\"text-align:left\">Name</th>\n<th style=\"text-align:left\">Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Name</td>\n<td style=\"text-align:left\">A title used for reference. eg: “Grant Access to Authenticated Users”</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Website</td>\n<td style=\"text-align:left\">Portal website</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Web Page</td>\n<td style=\"text-align:left\">Home</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Right</td>\n<td style=\"text-align:left\">Restrict Read</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Scope</td>\n<td style=\"text-align:left\">Exclude direct child web files</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Web Roles</td>\n<td style=\"text-align:left\">Add “Authenticated Users” web role</td>\n</tr>\n</tbody>\n</table></div></div><h3 id=\"set-adfs-as-default-log-in-entry\">Set ADFS as default log in entry<a title=\"#set-adfs-as-default-log-in-entry\" href=\"#set-adfs-as-default-log-in-entry\"></a></h3>\n<p>Add/update this site setting to make Portal set AD FS as default sign in channel. When we navigate to sign in page, it will automatically navigate the AD FS sign page, just like the ADFS button is clicked.</p>\n<ul>\n<li>Authentication/Registration/LoginButtonAuthenticationType - <a href=\"http://adfs.contoso.com/adfs/services/trust\">http://adfs.contoso.com/adfs/services/trust</a></li>\n</ul>\n<h3 id=\"additional\">Additional<a title=\"#additional\" href=\"#additional\"></a></h3>\n<ol>\n<li>\n<p>We need to add the AD FS url <a href=\"http://adfs.contoso.com\">http://adfs.contoso.com</a> as Local Intranet website in IE</p>\n<blockquote>\n<p>To locate the <strong>Local intranet</strong> dialog box in <strong>Internet Explorer</strong>, click <strong>Tools</strong>, click <strong>Internet Options</strong>, click <strong>Security</strong>, and then click <strong>Local intranet</strong>.</p>\n</blockquote>\n</li>\n<li>\n<p>In AD FS Management tool, make sure the “Windows Authentication” is ticked for Intranet.</p>\n<blockquote>\n<p>to find “Windows Authentication” in the AD FS Management tool, go to <strong>Authentication Policies</strong> &gt; <strong>Primary Authentication</strong> &gt; <strong>Global Setting</strong> &gt; Edit &gt; Intranet section</p>\n</blockquote>\n</li>\n</ol>\n","prev":{"title":"Power Apps Portal中JSON type Web Template的使用","link":"2022/09/15/json-type-web-template-in-portals"},"next":{"title":"算法题中归并的应用","link":"2022/09/15/merge-in-algorithm-problems"},"plink":"https://blog.citysouth.cc/2022/09/15/seamless-sign-in-portal-with-adfs/","toc":[{"id":"adfs-server","title":"ADFS Server","index":"1","children":[{"id":"create-an-ad-fs-relying-party-trust","title":"Create an AD FS relying party trust","index":"1.1"}]},{"id":"portal-management-in-crm-org","title":"Portal Management in CRM Org","index":"2","children":[{"id":"create-ad-fs-related-site-settings","title":"Create AD FS related site settings","index":"2.1"},{"id":"auto-navigate-to-sign-in-page","title":"Auto navigate to sign in page","index":"2.2"},{"id":"set-adfs-as-default-log-in-entry","title":"Set ADFS as default log in entry","index":"2.3"},{"id":"additional","title":"Additional","index":"2.4"}]}],"copyright":{"license":"自由转载-非商用-禁止演绎-保持署名 Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-nd/4.0/\" target=\"_blank\">CC BY-NC-ND 4.0</a>)","published":"September 15, 2022"},"reading_time":"803 words in 7 min"}