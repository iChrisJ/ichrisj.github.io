{"title":"Power Apps Portal中JSON type Web Template的使用","date":"2022-09-15T13:25:14.000Z","date_formatted":{"ll":"2022年9月15日","L":"2022/09/15","MM-DD":"09-15"},"thumbnail":"https://ichrisj.gitee.io/reslib/images/thumbnails/json-type-web-template-in-portals.jpg","link":"2022/09/15/json-type-web-template-in-portals","comments":true,"tags":["Microsoft CRM Portal","Power Apps Portal"],"updated":"2022-09-15T08:12:15.891Z","content":"<p>随着Power Apps Portal的Web API功能的增加，用户可以灵活的使用它对数据进行CURD。但是如果开放某个entity的Web API在去获取数据的话，它没办法像List OData Feed根据某个View查询出来的结果返回数据，也很难用link-entity做一些数据过滤。List OData Feed的功能快要退役了，不用OData, 我们该如何实现这种类似的功能呢？来尝试一下JSON type Web Template吧</p>\n<ol>\n<li>\n<p>创建一个 <strong>Web Template</strong>, 将<strong>MIME Type</strong>设值为<strong>application/json</strong>. 然后在<strong>Source</strong>中添加FetchXml和一些生成JSON数据的代码。可以参照下面的截图。</p>\n<h6 id=\"contact-json-web-template\">Contact JSON Web Template<a title=\"#contact-json-web-template\" href=\"#contact-json-web-template\"></a></h6>\n<p><img src=\"https://ichrisj.gitee.io/reslib/images/json-type-web-template-in-portals/contact-json-web-template.png?size=600x741\" alt=\"Contact JSON Web Template\" loading=\"lazy\" class=\"φbp\"></p>\n<p>下面是<strong>Contact JSON</strong> web template的示例代码。该示例中用来获取所有的contact记录，这些contact记录对应的Account的名字中包含&quot;Corporation&quot;。如果有’jobtitle’的参数传入，会过滤有改jobtitle的contact记录。如果有结果，返回包含name, id 和 email的json数据；反之返回No data.</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% fetchxml contacts %&#125;</span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">fetch</span> <span class=\"attr\">version</span>=<span class=\"string\">&quot;1.0&quot;</span> <span class=\"attr\">output-format</span>=<span class=\"string\">&quot;xml-platform&quot;</span> <span class=\"attr\">mapping</span>=<span class=\"string\">&quot;logical&quot;</span> <span class=\"attr\">distinct</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">entity</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;contact&quot;</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;fullname&quot;</span> /&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;contactid&quot;</span> /&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;emailaddress1&quot;</span> /&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">order</span> <span class=\"attr\">attribute</span>=<span class=\"string\">&quot;fullname&quot;</span> <span class=\"attr\">descending</span>=<span class=\"string\">&quot;false&quot;</span> /&gt;</span></span><br><span class=\"line\">     &#123;% if request.params[&#x27;jobtitle&#x27;] %&#125;</span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">filter</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;and&quot;</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">condition</span> <span class=\"attr\">attribute</span>=<span class=\"string\">&quot;jobtitle&quot;</span> <span class=\"attr\">operator</span>=<span class=\"string\">&quot;eq&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;&#123;&#123;request.params[&#x27;jobtitle&#x27;]&#125;&#125;&quot;</span> /&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;/<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">     &#123;% endif %&#125;</span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">link-entity</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;account&quot;</span> <span class=\"attr\">from</span>=<span class=\"string\">&quot;accountid&quot;</span> <span class=\"attr\">to</span>=<span class=\"string\">&quot;parentcustomerid&quot;</span> <span class=\"attr\">link-type</span>=<span class=\"string\">&quot;inner&quot;</span> <span class=\"attr\">alias</span>=<span class=\"string\">&quot;ab&quot;</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">filter</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;and&quot;</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">condition</span> <span class=\"attr\">attribute</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">operator</span>=<span class=\"string\">&quot;like&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;%Corporation%&quot;</span> /&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;/<span class=\"name\">link-entity</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">entity</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">fetch</span>&gt;</span></span><br><span class=\"line\"> &#123;% endfetchxml %&#125;</span><br><span class=\"line\"> &#123;% if contacts.results.entities.size &gt; 0 %&#125;</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   &quot;values&quot;:</span><br><span class=\"line\">   [</span><br><span class=\"line\">     &#123;% for contact in contacts.results.entities %&#125;</span><br><span class=\"line\">     &#123;</span><br><span class=\"line\">       &quot;name&quot;:  &quot;&#123;&#123;contact.fullname&#125;&#125;&quot;,</span><br><span class=\"line\">       &quot;id&quot;: &quot;&#123;&#123;contact.id&#125;&#125;&quot;,</span><br><span class=\"line\">       &quot;email&quot;: &quot;&#123;&#123;contact.emailaddress1&#125;&#125;&quot;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     &#123;% unless forloop.last %&#125;,&#123;% endunless %&#125;</span><br><span class=\"line\">     &#123;% endfor %&#125;</span><br><span class=\"line\">   ]</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> &#123;% else %&#125;</span><br><span class=\"line\"> No data.</span><br><span class=\"line\"> &#123;% endif %&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>创建一个<strong>Page Template</strong>, 将上面创建的<strong>Contact JSON</strong> web template设置给<strong>Web Template</strong>字段。不要选中<strong>Use Website Header and Footer</strong></p>\n<h6 id=\"get-contact-json-page-template\">Get Contact JSON Page Template<a title=\"#get-contact-json-page-template\" href=\"#get-contact-json-page-template\"></a></h6>\n<p><img src=\"https://ichrisj.gitee.io/reslib/images/json-type-web-template-in-portals/contact-json-page-template.png?size=398x320\" alt=\"Get Contact JSON Page Template\" loading=\"lazy\" class=\"φbp\"></p>\n</li>\n<li>\n<p>现在创建<strong>Web Page</strong>，并将<strong>Page Template</strong>字段设置成上面创建的<strong>Get Contact JSON</strong> page template, 并设置<strong>Partial URL</strong>, 这是之后获取json数据的URL.</p>\n<h6 id=\"get-contact-json-web-page:\">Get Contact JSON Web Page:<a title=\"#get-contact-json-web-page:\" href=\"#get-contact-json-web-page:\"></a></h6>\n<p><img src=\"https://ichrisj.gitee.io/reslib/images/json-type-web-template-in-portals/contact-json-web-page.png?size=397x315\" alt=\"Get Contact JSON Web Page\" loading=\"lazy\" class=\"φbp\"></p>\n</li>\n<li>\n<p>给对应Entity创建<strong>Table Permission</strong>, 添加权限，并将其分配给相应的<strong>Web Role</strong>. 这样拥有改web role的Portal User就可以获取数据了。如图，示例中我们为contact entity创建的table permission并添加了全局Read的权限(Read权限就够了)</p>\n<h5 id=\"contact---global-access-table-permission\">Contact - Global Access Table Permission<a title=\"#contact---global-access-table-permission\" href=\"#contact---global-access-table-permission\"></a></h5>\n<p><img src=\"https://ichrisj.gitee.io/reslib/images/json-type-web-template-in-portals/contact-global-access.png?size=398x323\" alt=\"Contact Global Access\" loading=\"lazy\" class=\"φbp\"></p>\n</li>\n<li>\n<p>我们来看看示例演示。这里我们将上面的table permission分配给Authenticated User web role. 我的CRM中有三条contact记录，她们对应的account的名字中包含&quot;Corporation&quot;。这三条记录中有俩条她们的jobtitle是Owner.</p>\n<ul>\n<li>当拥有Authenticated User web role的Portal User访问~/getcontactjson时<br>\n<img src=\"https://ichrisj.gitee.io/reslib/images/json-type-web-template-in-portals/contactjson1.png?size=366x299\" alt=\"\" loading=\"lazy\"></li>\n<li>如果在URL中添加参数，例如~/getcontactjson/?jobtitle=Owner<br>\n<img src=\"https://ichrisj.gitee.io/reslib/images/json-type-web-template-in-portals/contactjson2.png?size=422x277\" alt=\"\" loading=\"lazy\"></li>\n<li>如果是匿名访问~/getcontactjson<br>\n<img src=\"https://ichrisj.gitee.io/reslib/images/json-type-web-template-in-portals/contactjson3.png?size=381x100\" alt=\"\" loading=\"lazy\"><br>\n这样我们就完全可以在Portal中的某些页面写JavaScript代码发送Ajax请求来获取该数据并做相应的逻辑处理。</li>\n</ul>\n</li>\n</ol>\n<blockquote>\n<p>[!NOTE]<br>\n在步骤3中，我们将Home作为Parent Page, 其实也可以只用其他页面作为Parent Page，但访问的URL也要做相应的调整。</p>\n<p>因为getcontactjson是web page，我们还可以通过添加<strong>Web Page Access Control Rule</strong>来控制是否限制某些Web Role的Portal User来访问<br>\n<img src=\"https://ichrisj.gitee.io/reslib/images/json-type-web-template-in-portals/restrict-read-to-get-contact-json.png?size=546x292\" alt=\"Restrict Read to Get Contact JSON\" loading=\"lazy\"></p>\n</blockquote>\n<p>谢谢！</p>\n","prev":{"title":"Local Event Website Environment for Dynamics Marketing","link":"2022/10/06/local-event-website-environment-for-Dynamics-Marketing"},"next":{"title":"Seamless sign in Portal with ADFS","link":"2022/09/15/seamless-sign-in-portal-with-adfs"},"plink":"http://b.alphac.cn/2022/09/15/json-type-web-template-in-portals/","copyright":{"link":"<a href=\"http://b.alphac.cn/2022/09/15/json-type-web-template-in-portals/\" title=\"Power Apps Portal中JSON type Web Template的使用\">http://b.alphac.cn/2022/09/15/json-type-web-template-in-portals/</a>","license":"自由转载-非商用-禁止演绎-保持署名 (<a href=\"https://creativecommons.org/licenses/by-nc-nd/4.0/\" target=\"_blank\">CC BY-NC-ND 4.0</a>)","published":"2022年9月15日"},"reading_time":"955 字约 8 分钟"}